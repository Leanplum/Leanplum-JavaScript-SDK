___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Leanplum Web SDK",
  "description": "Leanplum SDK for tracking and variable A/B testing",
  "categories": [
    "MARKETING",
    "EXPERIMENTATION",
    "ANALYTICS"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "Leanplum",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "configuration",
    "displayName": "Configuration",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "LABEL",
        "name": "helpText",
        "displayName": "Get the keys from the \u003cstrong\u003eKeys \u0026 Settings\u003c/strong\u003e popup in your \u003ca href\u003d\"https://www.leanplum.com/dashboard#/account/apps\"\u003eApp Settings page\u003c/a\u003e."
      },
      {
        "type": "TEXT",
        "name": "applicationKey",
        "displayName": "App ID",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^app_..*"
            ]
          },
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "productionKey",
        "displayName": "Production Key",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "REGEX",
            "args": [
              "^prod_.*"
            ]
          },
          {
            "type": "NON_EMPTY"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "fireOptions",
    "displayName": "Firing options",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "method",
        "displayName": "Tag Options",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "load",
            "displayValue": "Only load SDK"
          },
          {
            "value": "track",
            "displayValue": "Track Event"
          },
          {
            "value": "trackPurchase",
            "displayValue": "Track Purchase"
          },
          {
            "value": "setUserAttributes",
            "displayValue": "Set User Attributes"
          }
        ],
        "simpleValueType": true,
        "subParams": []
      },
      {
        "type": "GROUP",
        "name": "trackOptions",
        "displayName": "",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "trackEvent",
            "displayName": "Event Name",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "method",
            "paramValue": "track",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "trackPurchaseOptions",
        "displayName": "",
        "subParams": [
          {
            "type": "TEXT",
            "name": "trackPurchaseValue",
            "displayName": "Value",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "trackPurchaseCurrency",
            "displayName": "Currency (optional)",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "STRING_LENGTH",
                "args": [
                  3,
                  3
                ]
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "method",
            "paramValue": "trackPurchase",
            "type": "EQUALS"
          }
        ],
        "groupStyle": "NO_ZIPPY"
      },
      {
        "type": "GROUP",
        "name": "setUserAttributesOptions",
        "displayName": "",
        "groupStyle": "NO_ZIPPY",
        "subParams": [],
        "enablingConditions": [
          {
            "paramName": "method",
            "paramValue": "setUserAttributes",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "PARAM_TABLE",
        "name": "trackParameters",
        "displayName": "Parameters (optional)",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "parameterName",
              "displayName": "Name",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "parameterValue",
              "displayName": "Value",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "newRowButtonText": "Add parameter",
        "newRowTitle": "Add parameter",
        "editRowTitle": "Edit parameter",
        "enablingConditions": [
          {
            "paramName": "method",
            "paramValue": "track",
            "type": "EQUALS"
          },
          {
            "paramName": "method",
            "paramValue": "trackPurchase",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "PARAM_TABLE",
        "name": "userAttributes",
        "displayName": "Attributes",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "parameterName",
              "displayName": "Name",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "parameterValue",
              "displayName": "Value",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "newRowButtonText": "Add attribute",
        "newRowTitle": "Add attribute",
        "editRowTitle": "Edit attribute",
        "enablingConditions": [
          {
            "paramName": "method",
            "paramValue": "setUserAttributes",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const callInWindow = require('callInWindow');
const makeNumber = require('makeNumber');

const LP_URL = 'https://cdn.jsdelivr.net/npm/leanplum-sdk@{LP_SDK_VERSION}/dist/leanplum.min.js';

// command queue
var lp = {};
var queue = [
  { "name": "setAppIdForProductionMode", "args": [data.applicationKey, data.productionKey] }
];

if (data.method !== "load") {
  // start a session
  queue.push(
    { "name": "useSessionLength", "args": [2*60*60] },
    { "name": "start", "args": [] }
  );
}


const parameters = {};
const parametersTable = data.trackParameters || data.userAttributes;
if (parametersTable) {
  parametersTable.forEach(parameter => {
    parameters[parameter.parameterName] = parameter.parameterValue;
  });
}

switch (data.method) {
  case "track":
    const trackArgs = [data.trackEvent];
    if (data.trackParameters) {
      trackArgs.push(parameters);
    }
    queue.push({ "name": "track", "args": trackArgs });
    break;

  case "trackPurchase":
    const trackPurchaseArgs = [makeNumber(data.trackPurchaseValue)];

    if (data.trackPurchaseCurrency || data.trackParameters) {
      trackPurchaseArgs.push(data.trackPurchaseCurrency || '');
    }

    if (data.trackParameters) {
      trackPurchaseArgs.push(parameters);
    }

    queue.push({ "name": "trackPurchase", "args": trackPurchaseArgs });
    break;

  case "setUserAttributes":
    queue.push({ "name": "setUserAttributes", "args": [parameters] });
    break;
}

{LP_SDK_METHODS}.forEach(function(name) {
  lp[name] = function() {
    queue.push({ name: name, args: arguments });
  };
});
setInWindow("Leanplum", lp, false);

// load script
injectScript(LP_URL, function() {
  callInWindow("Leanplum.applyQueue", queue);
  data.gtmOnSuccess();
}, data.gtmOnError, LP_URL);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://cdn.jsdelivr.net/npm/leanplum-sdk*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Leanplum"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "Leanplum.applyQueue"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Runs applyQueue once script loads
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] },
      { "name": "useSessionLength", "args": [2*60*60] },
      { "name": "start", "args": [] }
    ]);
- name: Can track events
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
      method: "track",
      trackEvent: "Track Test"
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] },
      { "name": "useSessionLength", "args": [2*60*60] },
      { "name": "start", "args": [] },
      { "name": "track", "args": ["Track Test"] }
    ]);
- name: Can track purchase events
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
      method: "trackPurchase",
      trackPurchaseValue: "42"
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] },
      { "name": "useSessionLength", "args": [2*60*60] },
      { "name": "start", "args": [] },
      { "name": "trackPurchase", "args": [42] }
    ]);
- name: Can track events with parameters
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
      method: "track",
      trackEvent: "Track Test",
      trackParameters: [{"parameterName":"param","parameterValue":"123"}]
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] },
      { "name": "useSessionLength", "args": [2*60*60] },
      { "name": "start", "args": [] },
      { "name": "track", "args": ["Track Test", { "param": "123" }] }
    ]);
- name: Can track purchase events in different currency
  code: |+
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
      method: "trackPurchase",
      trackPurchaseValue: "42.42",
      trackPurchaseCurrency: "BGN"
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] },
      { "name": "useSessionLength", "args": [2*60*60] },
      { "name": "start", "args": [] },
      { "name": "trackPurchase", "args": [42.42, "BGN"] }
    ]);

- name: Can track purchase events with parameters
  code: |+
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
      method: "trackPurchase",
      trackPurchaseValue: "42.42",
      trackPurchaseCurrency: undefined,
      trackParameters: [{"parameterName":"param","parameterValue":"123"}]
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] },
      { "name": "useSessionLength", "args": [2*60*60] },
      { "name": "start", "args": [] },
      { "name": "trackPurchase", "args": [42.42, "", { "param": "123" } ] }
    ]);

- name: Can set user attributes
  code: |+
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
      method: "setUserAttributes",
      trackPurchaseValue: "42.42",
      trackPurchaseCurrency: undefined,
      userAttributes: [{"parameterName":"param","parameterValue":"123"}]
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] },
      { "name": "useSessionLength", "args": [2*60*60] },
      { "name": "start", "args": [] },
      { "name": "setUserAttributes", "args": [{ "param": "123" } ] }
    ]);

- name: Can inject SDK without sending events
  code: |-
    mock('injectScript', function(url, onSuccess, onFailure) {
        onSuccess();
    });

    runCode({
      applicationKey: "app_foo",
      productionKey: "prod_bar",
      method: "load"
    });

    assertApi('callInWindow').wasCalledWith("Leanplum.applyQueue", [
      { "name": "setAppIdForProductionMode", "args": ["app_foo", "prod_bar"] }
    ]);


___NOTES___

Created on 5/19/2020, 5:00:41 PM


